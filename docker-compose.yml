services:
  postgres:
    image: postgres:18.1
    env_file:
      - .env
    restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
    stop_grace_period: "3s"
    shm_size: 512MB
    volumes:
      - pg_data:/var/lib/postgresql
      - ./db/init-database.sh:/docker-entrypoint-initdb.d/init-database.sh
      - ./db/postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    ports:
      - ${POSTGRES_PORT:-5432}:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U $${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  webservice:
    environment:
      - DB_NAME
      - DB_USER
      - DB_PASSWORD
      - ALLOW_ORIGINS
      - ALLOW_ORIGIN_REGEX
      - POSTGRES_PORT=5432
      - POSTGRES_HOST=postgres
      - WEB_CONCURRENCY
      - PYTHON_MAX_THREADS
    image: ghcr.io/swiss-seismological-service/hydws:1.3.0
    # build: .
    depends_on:
      postgres:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
    stop_grace_period: "3s"
    tty: true
    ports:
      - ${DOCKER_WEB_PORT:-8000}:8000
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:$${DOCKER_WEB_PORT:-8000}/hydws/docs'', timeout=5)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - backend

volumes:
  pg_data: {}
networks:
  backend: {}
